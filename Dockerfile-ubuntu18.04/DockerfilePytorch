FROM ubuntu:18.04

WORKDIR /root/
RUN apt-get update -y && apt-get upgrade -y && apt-get install -y openjdk-8-jre build-essential cmake wget curl git libunwind-dev
COPY miniconda.sh .
COPY spark-env.sh .
RUN ls ~/
RUN /bin/bash ~/miniconda.sh -b -p /opt/intel/oneapi/intelpython/latest
ENV PATH /opt/intel/oneapi/intelpython/latest/condabin:$PATH
RUN yes | conda create -n pytorch_mlperf python=3.7

# setup pytorch
SHELL ["conda", "run", "-n", "pytorch_mlperf", "/bin/bash", "-c"]
RUN conda install gxx_linux-64==8.4.0
RUN cp /opt/intel/oneapi/intelpython/latest/lib/python3.7/_sysconfigdata_x86_64_conda_cos6_linux_gnu.py /opt/intel/oneapi/intelpython/latest/lib/python3.7/_sysconfigdata_x86_64_conda_linux_gnu.py
RUN cp /opt/intel/oneapi/intelpython/latest/envs/pytorch_mlperf/lib/python3.7/_sysconfigdata_x86_64_conda_cos6_linux_gnu.py /opt/intel/oneapi/intelpython/latest/envs/pytorch_mlperf/lib/python3.7/_sysconfigdata_x86_64_conda_linux_gnu.py
RUN cp -r /opt/intel/oneapi/intelpython/latest/envs/pytorch_mlperf/lib/* /opt/intel/oneapi/intelpython/latest/envs/pytorch_mlperf/x86_64-conda-linux-gnu/sysroot/usr/lib64/
# install pytorch_mlperf required dependencies
RUN python -m pip install sklearn onnx tqdm lark-parser pyyaml
RUN conda install ninja cffi typing --no-update-deps
RUN conda install intel-openmp mkl mkl-include numpy -c intel --no-update-deps
RUN conda install -c conda-forge gperftools
# git clone pytorch v1.5.0-rc3
RUN git clone https://github.com/pytorch/pytorch.git && cd pytorch && git checkout tags/v1.5.0-rc3 -b v1.5-rc3 && git submodule sync && git submodule update --init --recursive
# git clone ipex v0.2
RUN git clone https://github.com/intel/intel-extension-for-pytorch.git && cd intel-extension-for-pytorch && git checkout tags/v0.2 -b v0.2 && git submodule sync && git submodule update --init --recursive
# apply ipex patch to pytorch and install
RUN cd intel-extension-for-pytorch && cp torch_patches/0001-enable-Intel-Extension-for-CPU-enable-CCL-backend.patch ../pytorch/ && cd ../pytorch && patch -p1 < 0001-enable-Intel-Extension-for-CPU-enable-CCL-backend.patch
RUN cp -r /opt/intel/oneapi/intelpython/latest/envs/pytorch_mlperf/lib/* /opt/intel/oneapi/intelpython/latest/envs/pytorch_mlperf/x86_64-conda-linux-gnu/sysroot/usr/lib64/
RUN cd pytorch && python setup.py install
RUN cd intel-extension-for-pytorch && python setup.py install
# git clone oneCCL and install
RUN git clone https://github.com/oneapi-src/oneCCL.git && cd oneCCL && git checkout 2021.1-beta07-1 && mkdir build && cd build && cmake .. -DCMAKE_INSTALL_PREFIX=/opt/intel/oneapi/intelpython/latest/envs/pytorch_mlperf/.local && make install -j
# git clone torchCCL and install
RUN git clone https://github.com/intel/torch-ccl.git && cd torch-ccl && git checkout 2021.1-beta07-1
RUN source /opt/intel/oneapi/intelpython/latest/envs/pytorch_mlperf/.local/env/setvars.sh && cd torch-ccl && python setup.py install
# install other dependencies
RUN python -m pip install --no-cache-dir --ignore-installed sigopt==7.5.0 pandas pytest prefetch_generator tensorboardX psutil
RUN python -m pip install "git+https://github.com/mlperf/logging.git@1.0.0"

# setup raydp pyrecdp pandas
SHELL ["conda", "run", "-n", "pytorch_mlperf", "/bin/bash", "-c"]
RUN pip install raydp-nightly pyrecdp pandas scikit-learn

# setup ssh
SHELL ["/bin/bash", "-c"]
RUN apt-get update -y && apt-get install -y openssh-server pssh sshpass vim
RUN sed -i 's/#Port 22/Port 12346/g' /etc/ssh/sshd_config
RUN sed -i 's/#   Port 22/    Port 12346/g' /etc/ssh/ssh_config
RUN echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config

# install spark
# RUN wget -qO- https://archive.apache.org/dist/spark/spark-3.2.1/spark-3.2.1-bin-hadoop3.2.tgz | tar xvz -C /home/
# RUN wget -qO- https://archive.apache.org/dist/hadoop/common/hadoop-3.3.1/hadoop-3.3.1.tar.gz | tar xvz -C /home/
# ENV HADOOP_HOME /home/hadoop-3.3.1
# ENV HADOOP_CONF_DIR /home/hadoop-3.3.1/etc/hadoop/
# RUN echo "export CLASSPATH=$CLASSPATH:`$HADOOP_HOME/bin/hdfs classpath --glob`" >> /etc/bash.bashrc
RUN conda init bash
RUN echo "source /opt/intel/oneapi/intelpython/latest/envs/pytorch_mlperf/.local/env/setvars.sh" >> /etc/bash.bashrc
RUN echo "export LD_LIBRARY_PATH=\$LD_LIBRARY_PATH:/opt/intel/oneapi/intelpython/latest/envs/pytorch_mlperf/lib/python3.7/site-packages/torch_ipex-0.1-py3.7-linux-x86_64.egg/" >> /etc/bash.bashrc
RUN echo "export LD_LIBRARY_PATH=\$LD_LIBRARY_PATH:/opt/intel/oneapi/intelpython/latest/envs/pytorch_mlperf/lib/python3.7/site-packages/torch/lib/" >> /etc/bash.bashrc
RUN echo "source ~/spark-env.sh" >> /etc/bash.bashrc
RUN echo "KMP_BLOCKTIME=1" >> /etc/bash.bashrc
RUN echo "KMP_AFFINITY=\"granularity=fine,compact,1,0\"" >> /etc/bash.bashrc
RUN echo "root:docker" | chpasswd
ENTRYPOINT [""]
