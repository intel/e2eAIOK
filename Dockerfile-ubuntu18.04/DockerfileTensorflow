FROM intel/oneapi-aikit:2021.4-devel-ubuntu18.04

SHELL ["/bin/bash", "-c"]
WORKDIR /root/
ENV PATH /opt/intel/oneapi/intelpython/latest/condabin:$PATH
RUN apt-get update -y && apt-get install -y git gcc-8 g++-8 \
        && update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-7 7 \
        && update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-8 8 \
        && update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-7 7 \
        && update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-8 8

RUN source /opt/intel/oneapi/setvars.sh --ccl-configuration=cpu_icc --force \
        && conda activate tensorflow \
        && python -m pip install --no-cache-dir intel-tensorflow==2.3.0 sigopt==7.5.0 pandas pytest future \
        && HOROVOD_WITHOUT_MPI=1 HOROVOD_CPU_OPERATIONS=CCL \
        HOROVOD_WITHOUT_MXNET=1 HOROVOD_WITHOUT_PYTORCH=1 HOROVOD_WITH_TENSORFLOW=1 \
        python -m pip install --no-cache-dir horovod[intel-tensorflow]==0.23.0 \
        && python -m pip install --no-cache-dir --no-deps tensorflow-transform==0.24.1 tensorflow-metadata==0.14.0 pydot dill

SHELL ["conda", "run", "-n", "base", "/bin/bash", "-c"]
RUN python -m pip install --no-cache-dir --ignore-installed sigopt==7.5.0 pandas pytest pyrecdp

RUN apt-get update -y && apt-get install -y openssh-server openjdk-8-jdk
RUN sed -i 's/#Port 22/Port 12344/g' /etc/ssh/sshd_config
RUN sed -i 's/#   Port 22/    Port 12344/g' /etc/ssh/ssh_config
# spark
RUN wget -qO- https://archive.apache.org/dist/spark/spark-3.2.1/spark-3.2.1-bin-hadoop3.2.tgz | tar xvz -C /home/
ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64
ENV SPARK_HOME /home/spark-3.2.1-bin-hadoop3.2
ENV PYTHONPATH $SPARK_HOME/python/:$PYTHONPATH
ENV PYTHONPATH $SPARK_HOME/python/lib/py4j-0.10.9.3-src.zip:$PYTHONPATH

RUN conda init bash
ENTRYPOINT [""]
